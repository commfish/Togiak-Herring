---
title: "2018 Togiak Herring ASL"
author: "Greg Buck"
date: "October 2, 2018"
output: html_document
---

# Rmarkdown

R markdown are dynamic documents. That means that they are a combination of text and r code designed---in one (.rmd) file ---to create a document and have the r code that build the tables and figures that go with the report embedded in the document. Markdown docs can be output in word doc, pdf, html, power point and latex formats. I find the html output the easiest to deal with. Here's a tutorial:

https://rmarkdown.rstudio.com/authoring_quick_tour.html

One of the biggest advantages of using R markdown is that it is a good way to explore and clean-up a data-set in a way that is completely transparent and documented. This is a quick example here documenting some of my herring ASL exploration on my way to defining sample groups. Hope it makes sense--I didn't include everything here, just visuals (figs and tables). The stats and associated r code can wait. 


### Set up

Set up some global settings and load librarys this document will use.


```{r setup, include=TRUE, warning=FALSE, message=FALSE}

knitr::opts_chunk$set(echo = TRUE)

library(readxl)    #read EXCEL spreadsheets
library(lubridate) #manage date and time data
library(ggplot2)   #make plots

```

### Read in data

The following code chunk reads in excel spreadsheets. These spreadsheets are query joins of 'fish' and 'header' tables in herring ACCESS db. It is easier to export ACCESS objects into EXCEL and then import directly into R. You can import directly from ACCESS but it is hard and your computer drivers need to be configured in a very specific way--this is just easier at this point in time. Anyway, read in excel spreadsheet, slim down the dataframe by keeping only the columns you want (1,2,3,8,14:19) then show the number of rows of data and summary stats.

```{r include=TRUE, warning=FALSE, message=FALSE}

a<-"C:/Users/gbbuck/Documents"
setwd(a)

tmp <- read_excel("qryHeaderFish_join.xlsx")
tmp<-tmp[,c(1:3,8,14:19)]
names(tmp)<-c("FileName","SampleDate","Gear","Subdistrict","FishNumber","Weight","Length","Sex","Gonad","Age")
dat.18<-tmp
nrow(tmp)
summary(tmp)


```

### Plot stuff

boxplot of weight by age. I only want ages between 4-27 with obvious weight outliers (that I will deal with later) excluded:

```{r include=TRUE, warning=FALSE, message=FALSE}

temp<-subset(tmp,(Age<28 & Age>3 & Weight<800 & Weight>50))
boxplot(Length~Age,data = temp,xlab="Age",ylab="Length")

```

After an iterative process of re-reading outliers (Weight and Length) till re-readings don't change many scales, I'll examine this years data with some historical data. 

```{r include=TRUE, warning=FALSE, message=FALSE}

load("S:/REG2/GBuck/Bristol Bay/Togiak Herring/MasterDB/TogHerr_master_workspace.RData")

#rename colums in 2018 df, re-arrange master df, make names identical
names(tmp)<-c("FileName","SampleDate","Gear","Subdistrict","FishNumber","Weight","Length","Sex","Gonad","Age")
master<-master[c(1,3,10,14,5,7,6,8,9,12)]
names(master)<-c("FileName","SampleDate","Gear","Subdistrict","FishNumber","Weight","Length","Sex","Gonad","Age")
nrow(tmp)+nrow(master) #check how many rows of data each df has
tmp2<-rbind(tmp,master) #row-bind historic and 2018 data.frames
nrow(tmp2) #check how many rows of data combined df has


```

make 'year' column, subset df to 2008-2018. Create 'grp' variable with 2 levels: 'historic' and 'current' then use table command to see how many fish you have in each group at each age (age 28-30 are age error read codes not valid ages).


```{r include=TRUE, warning=FALSE, message=FALSE}

tmp2$year<-year(tmp2$SampleDate)
tmp2<-tmp2[tmp2$year>2007,]
tmp2$grp<-"current"
tmp2[tmp2$year<2018,"grp"]<-"historic"

table(tmp2$Age,tmp2$grp)

```

Nex I want to make some stats and plots but limit the analysis to age 4-14 and remove some known weight outliers in historic data (subset command). Boxplot current weight at age with historic data.


```{r include=TRUE, warning=FALSE, message=FALSE}

tmp2<-subset(tmp2,(Age>3 & Age<14 & Weight<700 & Weight>75))
dat<-tmp2

# ggplot of paired boxplots 'fill' command
ggplot(dat,aes(x=as.factor(Age),y=Weight,fill=grp))+
  geom_boxplot()

```

Compare mean weight @ age + group (aggregate command). I'm looking to see if the means and standard deviations that I have in this years database and historic data look similar:

```{r include=TRUE, warning=FALSE, message=FALSE}

aggregate(Weight~Age+grp,data=dat,FUN=mean)  # mean weights

aggregate(Weight~Age+grp,data=dat,FUN=sd)   # standard deviations--weights

```

### Exploring purse seine data to decide sample groups

Looking at the ranges in the distribution and std deviations between historic and current year data I think I've scrubbed enough outliers and can move forward defining sampling periods. Subset by gear and age and make frequency table by subdistrict and sample date (subdistrict: 12=nunavachak, 21=hagemeister, 70=togiak).

```{r include=TRUE, warning=FALSE, message=FALSE}

tmp.ps<-subset(dat.18,(Age>3 & Age<14 & Gear==5)) # subset data by age and gear
table(tmp.ps$SampleDate,tmp.ps$Subdistrict)  # frequency table


```

Look at barplot of age by subdistrict first.


```{r include=TRUE, warning=FALSE, message=FALSE}

# ggplot example of plots on single panel 'facet_grid'
ggplot(tmp.ps,aes(x=Age))+
  geom_histogram()+
  facet_grid(Subdistrict~.,scales = "free")

```

Hagemeister and nunavachak look very similar. Togiak looks different than other two but only one sample was collected and I don't know if the togiak fish were from the east or west side of Togiak bay I don't know which other subdistrict they should pair with plus there isn't much harvest at that place and time so....

So a spatial, east/west grouping does not appear useful. Next lets look at temporal groupings. First let's try three groupings that spread the harvest and available samples roughly evenly:

group 1 <4/26
group 2 4/27 - 4/30
group 3 >4/30

Define periods ('grp') and plot:

```{r include=TRUE, warning=FALSE, message=FALSE}

tmp.ps$grp<-2
tmp.ps[tmp.ps$SampleDate<"2018-04-26","grp"]<-1
tmp.ps[tmp.ps$SampleDate>"2018-04-30","grp"]<-3


ggplot(tmp.ps,aes(x=Age))+
  geom_histogram()+
  facet_grid(grp~.,scales = "free")



```

replot with 6 groups


```{r include=TRUE, warning=FALSE, message=FALSE}

  tmp.ps$grp<-4
  tmp.ps[tmp.ps$SampleDate<"2018-04-29","grp"]<-3
  tmp.ps[tmp.ps$SampleDate<"2018-04-27","grp"]<-2
  tmp.ps[tmp.ps$SampleDate<"2018-04-26","grp"]<-1
  
  tmp.ps[tmp.ps$SampleDate>"2018-04-30","grp"]<-5
  tmp.ps[tmp.ps$SampleDate>"2018-05-01","grp"]<-6
  
  #table(tmp.ps$grp,tmp.ps$SampleDate)
  
  
  
  ggplot(tmp.ps,aes(x=Age))+
    geom_histogram()+
    facet_grid(grp~.,scales = "free")

```

I don't think it would be wise to break down further so.....6 PS sample groups it is.  Simple tables can be put in the text area of document and formated from there:

Group | Start Date | End Date | PS Harvest | Samples
------|------------|----------|------------|---------
1     | 4/18       | 4/26     | 1380       | 2393
2     | 4/26       | 4/26     | 3656       | 341
3     | 4/27       | 4/28     | 3218       | 1517
4     | 4/29       | 4/30     | 2336       | 671
5     | 5/1        | 5/1      | 3715       | 705
6     | 5/2        | 5/2      | 1550       | 568  
















